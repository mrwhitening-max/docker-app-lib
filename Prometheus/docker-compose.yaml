version: '3.8'

services:
  consul-agent:
    image: hashicorp/consul:1.22.3
    container_name: consul-agent
    hostname: ${CONSUL_NODE_NAME:-consul-prometheus}
    restart: unless-stopped
    network_mode: host
    volumes:
      - consul-data:/consul/data
    configs:
      - source: consul_config
        target: /consul/config/consul.hcl
      - source: prometheus_service
        target: /consul/config/prometheus-service.hcl
    command: >
      agent
      -config-file=/consul/config/consul.hcl
      -retry-join=${CONSUL_SERVER_IP}

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    network_mode: host
    volumes:
      - prometheus-data:/prometheus
    configs:
      - source: prometheus_config
        target: /etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
    depends_on:
      - consul-agent

volumes:
  consul-data:
  prometheus-data:

configs:
  consul_config:
    content: |
      datacenter = "${CONSUL_DATACENTER:-dc1}"
      data_dir   = "/consul/data"
      server     = false
      client_addr  = "0.0.0.0"
      bind_addr    = "{{ GetInterfaceIP \"eth0\" }}"
      advertise_addr = "{{ GetInterfaceIP \"eth0\" }}"
      connect { enabled = true }
      ports { grpc = 8502 }

  prometheus_service:
    content: |
      service {
        name = "prometheus"
        port = ${PROMETHEUS_PORT:-9090}
        tags = ["monitoring", "metrics"]
        connect {
          sidecar_service {}
        }
        check {
          http     = "http://127.0.0.1:${PROMETHEUS_PORT:-9090}/-/healthy"
          interval = "15s"
          timeout  = "3s"
        }
      }

  prometheus_config:
    content: |
      global:
        scrape_interval:     15s
        evaluation_interval: 15s

      scrape_configs:

        # Prometheus selbst
        - job_name: 'prometheus'
          static_configs:
            - targets: ['localhost:${PROMETHEUS_PORT:-9090}']

        # Consul Metriken
        - job_name: 'consul'
          metrics_path: '/v1/agent/metrics'
          params:
            format: ['prometheus']
          consul_sd_configs:
            - server: 'localhost:8500'
          relabel_configs:
            - source_labels: [__meta_consul_service]
              regex: 'consul'
              action: keep

        # Alle Services automatisch via Consul Discovery
        - job_name: 'consul-services'
          consul_sd_configs:
            - server: 'localhost:8500'
          relabel_configs:
            # Service Name als Job Label
            - source_labels: [__meta_consul_service]
              target_label: job
            # Node Name als Instance Label
            - source_labels: [__meta_consul_node]
              target_label: instance
            # Nur Services mit Tag "metrics" scrapen
            - source_labels: [__meta_consul_tags]
              regex: '.*,metrics,.*'
              action: keep
