services:
  # === CONSUL INFRASTRUCTURE ===
  consul-agent:
    image: hashicorp/consul:${CONSUL_VERSION:-latest}
    container_name: consul-agent
    hostname: ${CONSUL_NODE_NAME:-consul-agent}
    restart: unless-stopped
    network_mode: host
    volumes:
      - consul-data:/consul/data
    configs:
      - source: consul_config
        target: /consul/config/consul.hcl
    command: >
      agent
      -config-file=/consul/config/consul.hcl
      -retry-join=${CONSUL_SERVER_IP}
      -bind={{ GetInterfaceIP "eth0" }}

  registrator:
    image: ghcr.io/gliderlabs/registrator:latest
    container_name: registrator
    restart: unless-stopped
    network_mode: host
    command: -internal consul://localhost:8500
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock
    depends_on:
      - consul-agent

  # === APPLICATION SERVICES ===
  db:
    image: postgres:16
    container_name: n8n-postgres
    restart: unless-stopped
    environment:
      - SERVICE_NAME=postgres
      - SERVICE_TAGS=database,postgres,n8n,${CONSUL_NODE_NAME}
      - SERVICE_CHECK_TCP=5432
      - SERVICE_CHECK_INTERVAL=10s
      - POSTGRES_USER=n8n
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=n8n
    volumes:
      - /data/n8n/postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -h localhost -U n8n']
      interval: 5s
      timeout: 5s
      retries: 10

  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - SERVICE_NAME=n8n
      - SERVICE_TAGS=workflow,automation,${CONSUL_NODE_NAME}
      - SERVICE_CHECK_HTTP=/healthz
      - SERVICE_CHECK_INTERVAL=15s
      - SERVICE_CHECK_TIMEOUT=3s
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=db
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=n8n
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_SECURE_COOKIE=false
      - GENERIC_TIMEZONE=Europe/Berlin
    volumes:
      - /data/n8n/n8n_data:/home/node/.n8n
    depends_on:
      db:
        condition: service_healthy
    user: "0:0"

volumes:
  consul-data:

configs:
  consul_config:
    content: |
      datacenter = "${CONSUL_DATACENTER}"
      data_dir = "/consul/data"
      log_level = "${CONSUL_LOG_LEVEL}"
      
      server = false
      client_addr = "0.0.0.0"
      
      rejoin_after_leave = true
      
      performance {
        raft_multiplier = 1
      }
      
      recursors = ["8.8.8.8", "1.1.1.1"]